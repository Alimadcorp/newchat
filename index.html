<meta charset=UTF-8><meta content="width=device-width,initial-scale=1"name=viewport><title>Title</title><style>#app,body,html{height:calc(var(--vh) * 100)}#app,#bar{display:flex;gap:6px}body,button,html,textarea{background:#000;color:#0f0}#app,#feed{padding:6px}.me,a,body,html{color:#0f0}a,button{cursor:pointer}a,a:hover{text-decoration:underline}@font-face{font-family:GM;font-weight:light,normal,bold,bolder;src:url("https://corsproxy.io/?url=https://cdn.alimad.co/f/GeistMono.woff2") format("woff2")}body,html{margin:0;padding:0;overflow:hidden;font-family:GM,monospace}*{scrollbar-width:thin;scrollbar-color:#0f0 transparent}#app{flex-direction:column}button,textarea{border:1px solid #030;padding:8px;font:inherit;border-radius:0}textarea{flex:1;resize:none;height:42px;outline:#0000 solid 0;transition:outline .2s;max-height:50vh}textarea:focus{outline:#0f0 solid 2px}#feed{flex:1;overflow:auto;border:1px solid #030;background:linear-gradient(#001000,#000);font-size:14px}.msg{padding:4px 6px;margin:4px 0;word-break:break-word;max-width:90%}.other{color:#6f6}.meta{font-size:10px;opacity:.6;margin-bottom:2px}button{white-space:nowrap}button:hover{border-color:#0f0}img.emoji{width:1em;height:1em;vertical-align:text-bottom}img.msgi{width:80vw;max-width:400px;display:block;margin:4px 0}.msg.read{font-size:small;color:#0a0;font-style:italic;opacity:.7}a{text-decoration-color:#4f44}a:hover{color:#4f4}@media(max-width:500px){.dek{display:none}}#otherUserDot{display:none;width:8px;height:8px;border-radius:50%;background-color:#0f0;vertical-align:middle;margin-bottom:2px;margin-left:4px}</style><div id=app><div id=bar><textarea id=txt placeholder="> Enter..."></textarea><button id=send>Send</button></div><div style=color:#0f0;font-size:12px;opacity:1><span id=otherUserDot></span><span style=display:none>Online:<a href=# onclick=updateViewerCount()><strong id=viewer-count>...</strong></a> • </span><a href=# onclick=pull()><span id=poller>Loading...</span></a><span class=dek><span> • <strong id=tiem>Parsing...</strong></span><span> • <span id=daet>Reading...</span></span></span><span> • <a href=# onclick=upload() id=upload style=font-weight:700>Upload Image</a></span><span id=userstateo> • <span id=userstate></span></span><span class=dek style=float:right>Channel:<strong id=channelname></strong></span></div><div id=feed></div><input accept=image/* id=imgUpload style=display:none type=file></div><script defer src=https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js></script><script>const qp=new URLSearchParams(location.search);let user=qp.get("channel"),w,mc=0;user||(user=prompt("channel (username)")||"guest"+Math.random().toString(36).slice(2)),window.addEventListener("beforeunload",()=>{offline(),disconnect();let e="https://live.alimad.co/leave?channel="+encodeURIComponent("chat:"+user);if(navigator.sendBeacon)navigator.sendBeacon(e);else{let t=new XMLHttpRequest;t.open("GET",e,!1);try{t.send()}catch(n){}}});const g=e=>document.getElementById(e),uss=g("userstate"),usso=g("userstateo");user=user.trim(),g("channelname").textContent=user;const feed=g("feed"),txt=g("txt"),send=g("send");let seen=new Set,polling=1e4,cp=!1;setInterval(()=>{let e=g("tiem"),t=new Date;e.textContent=t.toLocaleTimeString();let n=g("daet");n.textContent=t.toLocaleDateString()},1e3);const safe=e=>String(e).replace(/[&<>]/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;"})[e]);function emojiify(e){return e.replace(/:([0-9a-zA-Z-_]+):/g,(e,t)=>`<img class="emoji" src="https://e.alimad.co/${t.replace(/^rofl$/i,"loll")}">`)}function timeAgo(e){if(!e)return"";let t=new Date,n=new Date(e);if(isNaN(n))return"";let a=Math.floor((t-n)/1e3);if(a<10)return"just now";if(a<60)return`${a}s ago`;let s=Math.floor(a/60);if(s<60){let i=a%60;return`${s}m${i?`, ${i}s`:""} ago`}let l=Math.floor(s/60);if(l<24)return`${l}h ago`;let r=e=>e.toString().padStart(2,"0"),o=new Date(t);return(o.setDate(t.getDate()-1),n.getDate()===o.getDate()&&n.getMonth()===o.getMonth()&&n.getFullYear()===o.getFullYear())?`Yesterday ${r(n.getHours())}:${r(n.getMinutes())}`:7>Math.floor((t-n)/864e5)?`${["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][n.getDay()]} ${r(n.getHours())}:${r(n.getMinutes())}`:n.getFullYear()===t.getFullYear()?`${["January","February","March","April","May","June","July","August","September","October","November","December"][n.getMonth()]} ${r(n.getDate())} ${r(n.getHours())}:${r(n.getMinutes())}`:`${["January","February","March","April","May","June","July","August","September","October","November","December"][n.getMonth()]} ${r(n.getDate())}, ${n.getFullYear()} ${r(n.getHours())}:${r(n.getMinutes())}`}function render(e,t){let n="",a="",s="",i=!1,l=!1;if(e&&"object"==typeof e){if(n=e.text??JSON.stringify(e),s=e.ip??"",l=w.includes(s),a=e.time??"",(i="read"===e.status)&&l)return}else n=String(e);let r=n+a+s;if(seen.has(r))return;seen.add(r);let o=document.createElement("div");if(i){o.className="msg read",o.textContent="-- Read "+timeAgo(a)+" --",feed.appendChild(o);return}o.className="msg "+(l?"me":"other");let u=document.createElement("span");u.className="meta",u.dataset.time=a,u.dataset.user=l?"you":"",u.dataset.ip=s,o.appendChild(u);let c=safe(n).replace(/&lt;(https?:\/\/\S+)&gt;/gi,(e,t)=>`<img class="msgi" src="${t}">`);c===safe(n)&&(c=safe(n).replace(/(https?:\/\/\S+)/gi,e=>`<a href="${e}" target="_blank">${e}</a>`)),o.insertAdjacentHTML("beforeend","<br>"+emojiify(c).replace(/\n/g,"<br>")),feed.appendChild(o),updateOne(u),t&&setTimeout(()=>{feed.scrollTo({top:feed.scrollHeight,behavior:"smooth"})},10)}function updateOne(e){let t=e.dataset.user||"",n=e.dataset.ip||"",a=timeAgo(e.dataset.time),s=[];t&&s.push(safe(t)),n&&s.push(safe(n)),a&&s.push(a),e.innerHTML="["+s.join("  •  ")+"]"}function updateAll(){document.querySelectorAll(".meta").forEach(updateOne)}async function pull(){if(!cp){cp=!0,g("poller").textContent="Refreshing...";try{let e=await fetch("https://log.alimad.co/api/pull?pwd=PASSWORDISBANANA&channel="+encodeURIComponent("chat:"+user),{cache:"no-store"});if(!e.ok)return;let t=await e.json(),n=t.logs??t.data??t;if(Array.isArray(n)||(n=Object.values(n)),!n.length)return;let a=[],s=n[0];for(let i=1;i<n.length;i++){let l=n[i],r=s.ip===l.ip,o=s.status===l.status,u=3e5>Math.abs(new Date(s.time)-new Date(l.time));r&&o&&u?s.text+="\n"+l.text:(a.push(s),s=l)}a.push(s),feed.innerHTML="",seen.clear();for(let c=0;c<a.length;c++)render(a[c],mc<n.filter(e=>"read"!=e.status).length);mc<n.filter(e=>"read"!=e.status).length&&!w.includes(n[n.length-1].ip&&"read"!=n[n.length-1].status)&&read(),mc=n.filter(e=>"read"!=e.status).length,cp=!1,g("poller").textContent="Refreshed"}catch{cp=!1,g("poller").textContent="Refresh failed"}}}async function read(){if(localStorage.getItem("chat:"+user+":lastRead")){let e=parseInt(localStorage.getItem("chat:"+user+":lastRead"));if(Date.now()-e<6e4)return}await fetch("https://log.alimad.co/api/log?channel="+encodeURIComponent("chat:"+user)+"&text=read&status=read"),localStorage.setItem("chat:"+user+":lastRead",Date.now().toString())}async function sendMsg(e){if(e.trim())try{await fetch("https://log.alimad.co/api/log?channel="+encodeURIComponent("chat:"+user)+"&text="+encodeURIComponent(e)),txt.value="",pull()}catch{}}function initiate(){pull(),updateViewerCount(),setInterval(pull,polling),setInterval(updateAll,5e3),setInterval(updateViewerCount,5e3)}send.onclick=()=>sendMsg(txt.value),txt.addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),sendMsg(txt.value))});let uv=!1;async function updateViewerCount(){if(!uv){uv=!0;try{g("viewer-count").style.color="#9f9";let e=await fetch("https://live.alimad.co/ping?app="+encodeURIComponent("chat:"+user));if(!e.ok)return;let t=await e.text(),n=parseInt(t)||0;g("viewer-count").textContent=n,g("viewer-count").style.color="#0f0"}catch(a){}uv=!1}}document.addEventListener("DOMContentLoaded",async()=>{w=JSON.parse((w=localStorage.getItem("myip"))||"[]"),fetch("https://api.ipify.org").then(e=>e.text()).then(e=>{w.includes(e)||w.push(e),localStorage.setItem("myip",JSON.stringify(w)),initiate(),connect(user)})});const tt=g("txt"),scaleI=()=>{tt.style.height="42px",tt.style.height=tt.scrollHeight+2+"px"};async function upload(e=!1,t=null){let n=document.getElementById("imgUpload"),a=async()=>{let e=n.files[0];if(!e)return;g("upload").textContent="Uploading...";let t=new FormData;t.append("image",e);try{let a=await fetch("https://api.imgbb.com/1/upload?key=0035f29ef2ddb2862584cd5114e4a7ee",{method:"POST",body:t}),s=await a.json();if(s.success){let i=s.data.url;txt.value+=`<${i}>`}g("upload").textContent="Upload Image"}catch(l){alert("Upload failed: "+l.message),g("upload").textContent="Upload Failed"}};if(e){if(t){let s=new DataTransfer;s.items.add(t),n.files=s.files,a()}}else n.click();n.onchange=a}function toTitleCase(e){return e.toLowerCase().split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}tt.addEventListener("input",scaleI),tt.addEventListener("input",typing),setInterval(scaleI,500),txt.addEventListener("paste",async e=>{let t=e.clipboardData?.items;if(t){for(let n of t)if(n.type.startsWith("image/")){e.preventDefault();let a=n.getAsFile();if(!a)return;await upload(!0,a)}}}),window.OneSignalDeferred=window.OneSignalDeferred||[],OneSignalDeferred.push(async function(e){await e.init({appId:"b885061e-346e-4289-b31f-f082b0704cbb",safari_web_id:"web.onesignal.auto.67fef31a-7360-4fd8-9645-1463ac233cef",notifyButton:{enable:!0}})});const WS_URL="wss://ws.alimad.co";let ws=null,currentChannel=null,listeners=[],lastState=null,lastStateTime=0,stateTimeout=null,typingTimeout=null,otherUsers=new Map,uonline=!1,offlineTimeouts=new Map;function ssend(e){ws&&1===ws.readyState&&ws.send(JSON.stringify(e))}function st(e){uss.textContent=e,usso.style.display=e?"inline":"none"}function setOtherUserStatus(e){let t=document.getElementById("otherUserDot");t.style.display="inline-block",t.style.backgroundColor=e?"green":"red"}function parseState(e,t){if(["idle","indeterminate"].includes(t)){st("");return}if("online"===t){uonline=!0,setOtherUserStatus(!0);return}if("active"===t){st("");return}if("outside"===t){st("In another tab");return}if("offline"===t){st(""),uonline=!1,setOtherUserStatus(!1);return}"typing"==t&&(t="typing..."),st(toTitleCase(t))}function connect(e){st("Connecting..."),ws&&1===ws.readyState||(currentChannel=e,(ws=new WebSocket("wss://ws.alimad.co")).onopen=()=>{ssend({type:"connect",channel:e}),st(""),setInterval(()=>online(),5e3)},ws.onmessage=e=>{let t;try{t=JSON.parse(e.data)}catch{t=e.data}if(t?.from&&!w.includes(t.from)&&t?.data?.state){let n=t.from,a=t.data.state;parseState(n,a),otherUsers.has(n)&&clearTimeout(otherUsers.get(n)),otherUsers.set(n,setTimeout(()=>{parseState(n,"indeterminate"),otherUsers.delete(n)},5e3)),offlineTimeouts.has(n)&&clearTimeout(offlineTimeouts.get(n)),offlineTimeouts.set(n,setTimeout(()=>{parseState(n,"offline"),offlineTimeouts.delete(n)},15e3))}listeners.forEach(e=>e(t))},ws.onclose=()=>{ws=null,st("Reconnecting..."),setTimeout(()=>connect(currentChannel),1e3)})}function disconnect(){ws&&(ws.onclose=()=>{}),ws&&ws.close(),ws=null,st("")}function setState(e){if(!ws||1!==ws.readyState||!currentChannel)return;let t=Date.now();e===lastState&&t-lastStateTime<2500||(ssend({type:"broadcast",channel:currentChannel,data:{state:e}}),lastState=e,lastStateTime=t,clearTimeout(stateTimeout),["online","typing"].includes(e)||(stateTimeout=setTimeout(()=>{ssend({type:"broadcast",channel:currentChannel,data:{state:"idle"}}),lastState="idle",lastStateTime=Date.now()},3e3)))}function typing(){setState("typing"),clearTimeout(typingTimeout),typingTimeout=setTimeout(()=>{setState("idle")},2e3)}function online(){setState("online")}function offline(){setState("offline")}function outside(){setState("outside")}function idling(){setState("idle")}function active(){setState("active")}function listen(e){listeners.push(e)}function updateVH(){document.documentElement.style.setProperty("--vh",.01*window.innerHeight+"px")}document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState?outside():"visible"===document.visibilityState&&active()}),updateVH(),window.addEventListener("resize",updateVH);</script>
